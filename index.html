<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Record</title>
</head>
<body style="margin:0;background:black">

<video id="video" autoplay playsinline muted style="width:100vw;height:100vh;object-fit:cover"></video>

<script>
  const video = document.getElementById("video");
  let stream, recorder, chunks = [];

  async function initCamera() {
    stream = await navigator.mediaDevices.getUserMedia({
      video: true,
      audio: true
    });
    video.srcObject = stream;
  }

  async function startRecord() {
    chunks = [];
    recorder = new MediaRecorder(stream, {
      mimeType: "video/webm;codecs=vp8,opus"
    });

    recorder.ondataavailable = e => e.data.size && chunks.push(e.data);

    recorder.onstop = async () => {
      const blob = new Blob(chunks, { type: "video/webm" });
      const base64 = await blobToBase64(blob);

      window.flutter_inappwebview?.callHandler(
        "onVideoRecorded",
        base64
      );
    };

    recorder.start();
    console.log("ðŸŽ¥ start");
  }

  function stopRecord() {
    recorder?.stop();
    console.log("â¹ stop");
  }

  function blobToBase64(blob) {
    return new Promise(resolve => {
      const r = new FileReader();
      r.onloadend = () => resolve(r.result.split(",")[1]);
      r.readAsDataURL(blob);
    });
  }

  initCamera();
</script>

</body>
</html>
